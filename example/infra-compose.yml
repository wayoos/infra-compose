version: '1'
environment:
  - GLOBAL=value

services:
  root:
    abstract: true
    commands:
      clean: [ls]
      init: [terraform in]
  terraform:
    abstract: true
    parent: root
    environment:
      - TEST=Value
    variables:
      backend-variables:
        file: .terraform/backend-variables.tf
        environment:
          - "project = \"wayoos-terraform-admin\""
          - "bucket = \"${branch.first}.tfstate.wayoos.info\""
    commands:
      init:
        - terraform init $HOME
        - terraform workspace new ${branch.last}
      up: [terraform apply]
      down: [terraform destroy -force]
  global:
    parent: terraform
    path: global
  bastion:
    parent: terraform
    path: mgmt/services/bastion
    environment:
      - OS_REGION_NAME2=EURCUSTOM
    commands:
      ssh: [./script-ssh-connect.sh]
      test:
        - $global down
  up:
    command:
      - $global up
      - $bastion up
      - $bastion ssh
      - $bastion test
  down:
    commands:
      all: [bastion down]
